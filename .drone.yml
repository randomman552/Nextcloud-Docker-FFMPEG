kind: pipeline
type: docker
name: Publish Docker Images

trigger:
    branch:
        - master
        - main
    event:
        exclude:
            - pull_request
    action:
        exclude:
            - opened

steps:
    # Apache image
    - name: apache-image
      image: plugins/docker
      settings:
          username:
              from_secret: docker-user
          password:
              from_secret: docker-key
          repo: randomman552/nextcloud-ffmpeg
          tags:
              - latest
              - apache
              - stable
              - stable-apache

    # FPM Alpine image
    - name: fpm-alpine-image
      image: plugins/docker
      settings:
          username:
              from_secret: docker-user
          password:
              from_secret: docker-key
          repo: randomman552/nextcloud-ffmpeg
          dockerfile: Dockerfile.fpm-alpine
          tags:
              - fpm-alpine
              - stable-fpm-alpine

    # FPM Image
    - name: fpm-image
      image: plugins/docker
      settings:
          username:
              from_secret: docker-user
          password:
              from_secret: docker-key
          repo: randomman552/nextcloud-ffmpeg
          dockerfile: Dockerfile.fpm
          tags:
              - fpm
              - stable-fpm

    # Reporting
    - kind: template
      name: build-reporter
      load: report-build.yaml
      data:
          depends_on:
              - apache-image
              - fpm-alpine-image
              - fpm-image
